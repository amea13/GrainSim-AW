# 验收用例与通过标准（Acceptance Criteria）— v0.1

> 目的：给“这一阶段”一个**能自动检查的过线标准**。跑完这些用例，代表骨架与关键约束正确。

## 0. 前置条件

* 使用 `config_schema.md` 中的键名与默认值。
* 边界条件默认 `neumann0`（零通量），除非用例特别说明。
* 浮点使用 `float64`；数组形状 `(Ny, Nx)`，只在 `.core` 上做统计。

---

## A 组：骨架就绪（不依赖物理细节）

**A1. 配置加载与校验**

* 条件：最小配置文件（与 `config_schema.md` 的“最小示例”一致）。
* 通过：加载成功，无缺键；非法值（如 `dt<=0`）能在启动时报出明确错误。

**A2. 空物理可运行**

* 条件：临时关闭所有物理更新（Nucleation、Interface、MDCS、SoluteSolver 为空实现，只推进时钟）。
* 通过：到达 `t_end` 正常退出；输出目录包含 `meta` 与至少一份快照文件。

**A3. Writer/I-O 协议**

* 条件：运行 A2。
* 通过：快照包含持久字段 `fs, CL, CS, grain_id, theta, L_dia,(lock 可选)` 与元数据 `t, step`；`meta` 中包含完整配置快照与随机种子。

**A4. 不变量检查（空物理）**

* 条件：运行 A2。
* 通过：`.core` 内 `0≤fs≤1`；`CL, CS` 为有限数；任何一步不触发越界告警。

**A5. 随机性可复现**

* 条件：同一配置、同一 `seed` 运行两次。
* 通过：末次快照在数值上**逐字段相等**（bitwise 相等或 `L∞<1e-12`）。

**A6. 检查点可重启**

* 条件：启用 `checkpoint_every`；在中途检查点退出，再从检查点恢复继续到 `t_end`。
* 通过：最终快照与“不中断直接跑完”的结果相同（阈值同 A5）。

---

## B 组：边界与适配器（轻物理）

**B1. ghost 与边界镜像**

* 条件：构造一个随坐标线性变化的场 `X(i,j)=i+j` 写入 `.core`，调用 `update_ghosts(neumann0)`。
* 通过：四周 ghost 带等于相邻内点（逐元素相等）。

**B2. 周期边界**

* 条件：`bc_x=periodic`；在左/右边各放一个不同常量，调用 `update_ghosts`。
* 通过：左侧 ghost 等于右侧 `.core` 对应行，右侧 ghost 等于左侧 `.core` 对应行。

**B3. 温度适配器/常数模式**

* 条件：`temperature.mode=constant, T_const=T0`。
* 通过：`sample()` 返回全域恒等于 `T0` 的数组。

---

## C 组：Nucleation（形核）

**C1. 取向类抽样一致性**

* 条件：`fold=4, N_theta=48`；在足够大的液相区域、固定 `seed`，运行若干步只做形核（其余模块空实现）。
* 通过：统计 `theta_class` 的计数，最大相对偏差 ≤ 5%（期望均匀分布）。若未存储 `theta_class`，则对 `theta` 按 `N_theta` 等分落桶统计。

**C2. 激活率随过冷单调**

* 条件：对两个场景，除初始过冷 `ΔT` 外其他相同；场景 A 过冷低、场景 B 过冷高。
* 通过：在相同时长内，B 的新核数 ≥ A 的新核数。

---

## D 组：MDCS（几何与捕获）

**D1. 单步更新有界**

* 条件：给定 `V_n, dt`，只更新 MDCS（其余为空）。
* 通过：所有界面胞 `Δfs = GF*V_n*dt/L_n` 满足 `0≤Δfs≤1`，写回后 `0≤fs≤1`；`L_dia` 非负、单调不减。

**D2. 捕获阈值生效**

* 条件：`fs_capture_threshold=τ`；构造一个界面胞 `fs` 从 `τ−ε` 跳到 `τ+ε` 的场景。
* 通过：相邻被标记捕获的液相元胞数与实现规则一致（至少应发生捕获）。

**D3. 等向匀速基准**

* 条件：关闭各向异性，令 `V_n=const`；从单核起步，演化若干步。
* 通过：等效“半径”随时间线性增长，`|R(t)−R(0)−V_n t| ≤ ε`（建议 ε=1 个网格尺度）。

---

## E 组：SoluteSolver（守恒）

**E1. 总溶质量守恒（零通量）**

* 条件：固定 `fs`（不增长），只解溶质扩散；`bc=neumann0`。
* 通过：定义 `M=Σ[(1−fs)CS + αCL]·dx·dy`，所有步 `|M(t+dt)−M(t)| ≤ tol_mass`（默认 `1e-8·max(1,|M(0)|)`）。

**E2. 制造解验证（1D 周期）**

* 条件：`bc_x=periodic`，初始化 `CL(x,0)=A cos(kx)`，`fs=0, CS` 常数，令 `D_L=D`。
* 通过：数值解满足 `CL(x,t)≈A cos(kx) e^{−Dk^2 t}`，`L2` 相对误差 ≤ 1%。

**E3. 伴随源项的平衡性（耦合）**

* 条件：在一个小区块内让 `fs` 以恒定速率增长，记录域内源项积分 `S=Σ(1−k)CL·∂fs/∂t·dx·dy·dt`。
* 通过：`M(t)` 的变化量接近 `S`（误差在若干个 `tol_mass` 以内）。

---

## F 组：性能与日志（轻量）

**F1. 日志最小性**

* 条件：默认 `log_level=INFO` 运行一个中等规模用例。
* 通过：每步日志行数有限（≤3），包含步号、时间、关键最大/最小值；`DEBUG` 模式下提供额外诊断计数。

**F2. 基线耗时**

* 条件：`nx=ny=128, steps=200` 的用例，在单核 CPU 上运行（无并行优化）。
* 通过：总耗时处于可接受范围（先设占位阈值 5\~30s，后续根据实现调整）。

---

## 通过与交付

* 通过条件：全部通过。
* 交付物：

  1. 一键脚本 `make test-accept` 或等价命令，跑完并输出汇总报告。
  2. 输出目录下的快照样例与 `meta`。
  3. 若某项暂未实现，报告中应标记为 **SKIP**，并给出计划落地版本号。
