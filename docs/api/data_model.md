# 数据模型（Data Model）—— v0.2（2025-08-17）

本文件定义 Dendrite CA 项目的数据结构与约定。目标是将“逻辑域”“存储域”“ghost 层”“持久字段”和“临时工作区”一次说清，以支撑数值实现、快照与重启。

## 1. 术语与约定

* 逻辑域：真实计算区域的网格，尺寸为 `ny × nx`。
* ghost 层：为差分模板与邻域操作提供的“幽灵单元”，厚度为 `g = nghost`，在四周各加 `g` 层。
* 存储域：包含 ghost 层的实际数组尺寸 `Ny = ny + 2g`，`Nx = nx + 2g`。
* 索引：

  * 逻辑域索引 `i ∈ [0, ny-1]，j ∈ [0, nx-1]`。
  * 存储域索引 `I ∈ [0, Ny-1]，J ∈ [0, Nx-1]`。
  * 二者映射 `I = i + g，J = j + g`。
  * 逻辑域对应的切片为 `core = arr[g:-g, g:-g]`。
* 坐标：元胞中心网格。`x_j = (j + 0.5)·dx`，`y_i = (i + 0.5)·dy`。不为每个格点单独存 `x, y`，需要时按索引与步长计算，或提供一维 `x_coords[Nx], y_coords[Ny]`。
* 类型：浮点统一 `float64`，整型字段给出具体位宽（如 `int32`）。数组默认 C-order。

## 2. 网格 Grid

* 参数：

  * `nx, ny` 正整数，逻辑域尺寸。
  * `dx, dy` 正浮点，网格步长 \[m]。
  * `nghost = g` 非负整数，ghost 层厚度。
* 建议默认：因 MDCS 使用直径约 `7·Δx` 的圆核，最大邻域半径近似 3 个单元，建议初值 `g = 3`。若仅用五点拉普拉斯，可降为 `g = 1`。实际值取各启用模块所需最大模板半径的上界。
* 掩码：提供典型布尔掩码，形状均为 `(Ny, Nx)`。

  * `mask_core` 为 `True` 的区域是逻辑域 `g:-g, g:-g`。
  * `mask_boundary` 四周 ghost 区域为 `True`。

## 3. 场变量与分层

将字段分为“持久字段”“派生量”“模块工作区”。只有持久字段进入快照并参与重启。

### 3.1 持久字段（进入快照）

| 名称               | 形状         | dtype   | 单位        | 取值范围              | 说明                              |
| ---------------- | ---------- | ------- | --------- | ----------------- | ------------------------------- |
| `fs`             | `(Ny, Nx)` | float64 | 无量纲       | \[0,1]            | 固相体积分数，主状态量                     |
| `CL`             | `(Ny, Nx)` | float64 | 质量分数或原子分数 | 见配置               | 液相体平均浓度                         |
| `CS`             | `(Ny, Nx)` | float64 | 同上        | 见配置               | 固相体平均浓度                         |
| `grain_id`       | `(Ny, Nx)` | int32   | 无         | ≥ -1              | 晶粒编号，-1 表示未归属                   |
| `theta`          | `(Ny, Nx)` | float64 | rad       | 任意实数              | 晶粒取向角，周期性按 `2π` 处理              |
| `theta_class` 可选 | `(Ny, Nx)` | int16   | 无         | 液相取哨兵值，界面/固相取离散类  | 取向离散类索引，用于再现“Class(Nθ)”抽样与可视化映射 |
| `L_dia`          | `(Ny, Nx)` | float64 | m         | ≥ 0               | MDCS 偏心正方形半对角线长度                |
| `lock` 可选        | `(Ny, Nx)` | uint8   | 无         | {0,1}             | 元胞锁标记（TL）                       |
| `state` 可选       | `(Ny, Nx)` | int8    | 无         | {液=1, 界面=0, 固=-1} | 若频繁使用可持久存，否则由 `fs` 阈值即时得到       |
| **`T`**          | `(Ny, Nx)` | float64 | K         | 任意实数              | 温度场，现改为持久字段，进入快照与重启             |

备注：ghost 区域中的持久字段值由边界条件规则写入，不参与统计或守恒计算。

### 3.2 派生量（不入快照）

| 名称                       | 形状             | 说明                                     |
| ------------------------ | -------------- | -------------------------------------- |
| `α = 1 - fs`             | `(Ny, Nx)`     | 液相体积分数，可按需即时计算                         |
| `nx, ny`                 | `(Ny, Nx)` 或稀疏 | 界面法向分量，只对界面胞有意义                        |
| `kappa`                  | `(Ny, Nx)` 或稀疏 | 曲率                                     |
| `ani`                    | `(Ny, Nx)` 或稀疏 | 各向异性因子                                 |
| `Vn, vel_x, vel_y`       | 稀疏             | 法向与分量速度                                |
| `C_L_star (C_L^*)`       | `(Ny, Nx)` 或稀疏 | 界面液相一侧浓度（局部热平衡量）；当步计算，用于 Stefan 边界与生长律 |
| `C_S_star (C_S^*)`       | `(Ny, Nx)` 或稀疏 | 界面固相一侧浓度（通常 `= k·C_L^*`）；当步计算          |
| `MDCS_x, MDCS_y, P1..P4` | 稀疏             | 由 `L_dia, theta, 单元中心` 当步计算的几何量        |
| `delta_fs, L_n, w_ij`    | 模块内            | 本步更新与几何权重                              |

### 3.3 模块工作区（不入快照）

* 溶质求解器系数与残差：`Tae1, Taw1, ... Clresi, ...` 等。
* 形核概率与随机判定的中间量：`nuc_p, P`。判定结果应体现在 `grain_id` 与 `fs`。
* 任何仅用于某模块内部的辅助数组与缓存。

### 3.4 取向角字段与量化策略

（保持不变，略）

## 4. ghost 层策略

（保持不变，略）

## 5. 边界与掩码

（保持不变，略）

## 6. 不变量与验证

（保持不变，略）

## 7. 快照与重启

* 状态快照最小集合：`fs, CL, CS, grain_id, theta, theta_class(可选), L_dia, lock(可选), T`，另存元数据：完整配置、随机种子、版本与时间戳。
* 调试快照开关：在配置中提供可选列表，允许额外写出 `nx, ny, Vn, kappa` 等派生量，默认关闭。
* 重启：从状态快照恢复上述持久字段与随机数状态。模块工作区与派生量均在重启后按需要重新计算。

## 8. 内存与性能约定

（保持不变，略）

## 9. 扩展与命名规范

（保持不变，略）

## 10. 示例切片与访问

（保持不变，略）
