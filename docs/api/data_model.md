# 数据模型（Data Model）—— v0.1（2025-08-14）

本文件定义 Dendrite CA 项目的数据结构与约定。目标是将“逻辑域”“存储域”“ghost 层”“持久字段”和“临时工作区”一次说清，以支撑数值实现、快照与重启。

## 1. 术语与约定

* 逻辑域：真实计算区域的网格，尺寸为 `ny × nx`。
* ghost 层：为差分模板与邻域操作提供的“幽灵单元”，厚度为 `g = nghost`，在四周各加 `g` 层。
* 存储域：包含 ghost 层的实际数组尺寸 `Ny = ny + 2g`，`Nx = nx + 2g`。
* 索引：

  * 逻辑域索引 `i ∈ [0, ny-1]，j ∈ [0, nx-1]`。
  * 存储域索引 `I ∈ [0, Ny-1]，J ∈ [0, Nx-1]`。
  * 二者映射 `I = i + g，J = j + g`。
  * 逻辑域对应的切片为 `core = arr[g:-g, g:-g]`。
* 坐标：元胞中心网格。`x_j = (j + 0.5)·dx`，`y_i = (i + 0.5)·dy`。不为每个格点单独存 `x, y`，需要时按索引与步长计算，或提供一维 `x_coords[Nx], y_coords[Ny]`。
* 类型：浮点统一 `float64`，整型字段给出具体位宽（如 `int32`）。数组默认 C-order。

## 2. 网格 Grid

* 参数：

  * `nx, ny` 正整数，逻辑域尺寸。
  * `dx, dy` 正浮点，网格步长 \[m]。
  * `nghost = g` 非负整数，ghost 层厚度。
* 建议默认：因 MDCS 使用直径约 `7·Δx` 的圆核，最大邻域半径近似 3 个单元，建议初值 `g = 3`。若仅用五点拉普拉斯，可降为 `g = 1`。实际值取各启用模块所需最大模板半径的上界。
* 掩码：提供典型布尔掩码，形状均为 `(Ny, Nx)`。

  * `mask_core` 为 `True` 的区域是逻辑域 `g:-g, g:-g`。
  * `mask_boundary` 四周 ghost 区域为 `True`。

## 3. 场变量与分层

将字段分为“持久字段”“派生量”“模块工作区”。只有持久字段进入快照并参与重启。

### 3.1 持久字段（进入快照）

| 名称               | 形状         | dtype   | 单位        | 取值范围              | 说明                              |
| ---------------- | ---------- | ------- | --------- | ----------------- | ------------------------------- |
| `fs`             | `(Ny, Nx)` | float64 | 无量纲       | \[0,1]            | 固相体积分数，主状态量                     |
| `CL`             | `(Ny, Nx)` | float64 | 质量分数或原子分数 | 见配置               | 液相体平均浓度                         |
| `CS`             | `(Ny, Nx)` | float64 | 同上        | 见配置               | 固相体平均浓度                         |
| `grain_id`       | `(Ny, Nx)` | int32   | 无         | ≥ -1              | 晶粒编号，-1 表示未归属                   |
| `theta`          | `(Ny, Nx)` | float64 | rad       | 任意实数              | 晶粒取向角，周期性按 `2π` 处理              |
| `theta_class` 可选 | `(Ny, Nx)` | int16   | 无         | 液相取哨兵值，界面/固相取离散类  | 取向离散类索引，用于再现“Class(Nθ)”抽样与可视化映射 |
| `L_dia`          | `(Ny, Nx)` | float64 | m         | ≥ 0               | MDCS 偏心正方形半对角线长度                |
| `lock` 可选        | `(Ny, Nx)` | uint8   | 无         | {0,1}             | 元胞锁标记（TL）                       |
| `state` 可选       | `(Ny, Nx)` | int8    | 无         | {液=1, 界面=0, 固=-1} | 若频繁使用可持久存，否则由 `fs` 阈值即时得到       |

备注：ghost 区域中的持久字段值由边界条件规则写入，不参与统计或守恒计算。

### 3.2 派生量（不入快照）

| 名称                       | 形状                   | 说明                                                             |
| ------------------------ | -------------------- | -------------------------------------------------------------- |
| `α = 1 - fs`             | `(Ny, Nx)`           | 液相体积分数，可按需即时计算                                                 |
| `T` 可选                   | `(Ny, Nx)` 或由适配器按需提供 | 当前时间步的温度缓冲；通常由外部温度适配器插值获得，可不缓存，若跨模块多次使用则在适配器维护 `tmp_T` 缓冲；不入快照 |
|                          |                      |                                                                |
| `nx, ny`                 | `(Ny, Nx)` 或稀疏       | 界面法向分量，只对界面胞有意义                                                |
| `kappa`                  | `(Ny, Nx)` 或稀疏       | 曲率                                                             |
| `ani`                    | `(Ny, Nx)` 或稀疏       | 各向异性因子                                                         |
| `Vn, vel_x, vel_y`       | 稀疏                   | 法向与分量速度                                                        |
| `C_L_star (C_L^*)`       | `(Ny, Nx)` 或稀疏       | 界面液相一侧浓度（局部热平衡量）；当步计算，用于 Stefan 边界与生长律                         |
| `C_S_star (C_S^*)`       | `(Ny, Nx)` 或稀疏       | 界面固相一侧浓度（通常 `= k·C_L^*`）；当步计算                                  |
|                          |                      |                                                                |
| `MDCS_x, MDCS_y, P1..P4` | 稀疏                   | 由 `L_dia, theta, 单元中心` 当步计算的几何量                                |
| `delta_fs, L_n, w_ij`    | 模块内                  | 本步更新与几何权重                                                      |

### 3.3 模块工作区（不入快照）

* 溶质求解器系数与残差：`Tae1, Taw1, ... Clresi, ...` 等。
* 形核概率与随机判定的中间量：`nuc_p, P`。判定结果应体现在 `grain_id` 与 `fs`。
* 任何仅用于某模块内部的辅助数组与缓存。

### 3.4 取向角字段与量化策略

* **取向连续量**：`theta` 为主字段，单位 rad，建议在读写时规范化到 `[0, 2π)`。
* **取向离散类**（可选）：`theta_class` 存储离散类索引 `c`，用于再现基于等分扇区的随机取向抽样与可视化；液相处设哨兵值（建议 `-10`）。
* **参数来自配置**（建议在 `[physics.orientation]` 中声明）：

  * `fold`：晶体对称性（二维默认 4，对应四折对称）。
  * `n_class = Nθ`：每个主扇区的等分数（例如 48）。
  * `class_liq_sentinel`：液相的类哨兵，默认 `-10`。
* **二维等分扇区抽样公式**（与文献中 Class(48) 一致的通式）：

  * 抽样 `c ∈ {0, 1, …, Nθ}` 均匀整数；
  * 扇区角宽 `Δ = π / fold`；
  * 局部取向 `θ_local = ((c + 0.5) / Nθ - 1/2) · Δ`，即 `θ_local ∈ [-Δ/2, +Δ/2]`；
  
  * 若需要全局取向，可在不同主轴上加上 `k·Δ`（`k ∈ {0,…,fold-1}`）后再规范到 `[0, 2π)`；实际实现中通常直接以 `θ_local` 配合各向异性函数使用。
* **一致性约束**：

  * 当存在 `theta_class` 时，`theta` 应等于上述量化规则产生的角或其等价规范值；
  * 液相处 `theta_class = class_liq_sentinel`，`theta` 可置 `NaN` 或任意数值但不得被使用；
  * 需要可重复性时，离散类抽样使用框架统一的随机数流与记录的 `seed`。
* **可视化映射建议**：

  * 二维可将 `theta` 线性映射到 HSV 的色相通道或离散调色板；
  * 若扩展到三维，可选存 `w = (w1, w2, w3)` 作为方向余弦并映射到 RGB，或按文献中的整数分段映射法生成 `C_ER, C_EG, C_EB`，但不作为本阶段持久字段。

## 4. ghost 层策略

* 更新时机：每个时间步开始时调用一次 `update_ghosts()`，随后所有计算仅读写 `.core`。若某模块在本步多次修改核心字段，必须在其内部保证再次更新 ghost 后再做需要边界值的运算。
* 边界类型与赋值：

  * 零通量（Neumann 0）：ghost 等于相邻内点值（镜像）。
  * 定值（Dirichlet）：ghost 赋指定边界值。
  * 周期：ghost 从对侧拷贝。
* 不变量：任何对字段的遍历更新应限制在 `.core`，禁止直接写 ghost 区域。

## 5. 边界与掩码

* 推荐维护以下掩码，形状 `(Ny, Nx)`：

  * `mask_liq, mask_int, mask_sol` 三态掩码。若不持久存 `state`，则按 `fs` 阈值即时生成。
  * `mask_core, mask_ghost` 如第 2 节定义。
* 任何全域统计（例如守恒量）都在 `mask_core` 上计算，ghost 区域永不计入。

## 6. 不变量与验证

* 数值域：`.core` 内 `0 ≤ fs ≤ 1`；`CL, CS` 非 NaN、非 Inf。
* 守恒性：零通量条件下，逻辑域总溶质量在阈值内守恒。推荐守恒量定义

  $$
  M = \sum_{core} \big(α·CL + (1-α)·CS\big)·dx·dy
  $$

  在连续时间步 `M(t+dt)` 与 `M(t)` 之差的绝对值低于阈值，例如 `tol_mass = 1e-8 · max(1, |M(0)|)`。
* 取向角规范化：`theta` 读写时统一映射到 `[0, 2π)`；存在 `theta_class` 时，`theta` 与量化规则（§3.4）一致。
* 取向离散类约束：`theta_class ∈ {class_liq_sentinel} ∪ [0, Nθ]`，液相取 `class_liq_sentinel`，界面/固相取整型类索引。

## 7. 快照与重启

* 状态快照最小集合：`fs, CL, CS, grain_id, theta, theta_class(可选), L_dia, lock(可选)`，另存元数据：完整配置、随机种子、版本与时间戳。
* 调试快照开关：在配置中提供可选列表，允许额外写出 `nx, ny, Vn, kappa` 等派生量，默认关闭。
* 重启：从状态快照恢复上述持久字段与随机数状态。模块工作区与派生量均在重启后按需要重新计算。

## 8. 内存与性能约定

* 统一 `float64`，便于数值稳定与跨平台一致性。必要时可在后续阶段提供 `float32` 选项。
* 避免为每个格点存 `x, y`。如需频繁使用，提供一维坐标数组或按索引即时计算。
* 对界面相关的仅局部有效量，优先采用**稀疏前沿列表**：例如 `front = [(I_k, J_k)]`，仅对这些索引计算法向、顶点等。
* 所有更新例程尽量向量化，仅在稀疏前沿上做小循环。

## 9. 扩展与命名规范

* 新增持久字段需在本文件登记：名称、dtype、单位、范围、是否受 ghost 规则约束。
* 命名前缀建议：

  * `C*` 为浓度场（`CL, CS`）。
  * `mask_*` 为布尔掩码。
  * `tmp_*` 为模块内部临时数组。
  * `dbg_*` 为可选调试输出。

## 10. 示例切片与访问

* 逻辑域视图：`fs_core = fs[g:-g, g:-g]`。
* 更新节拍：`update_ghosts() → compute_on_core() → write_core() → update_ghosts_if_needed()`。
* 前沿遍历：对 `front` 中的 `(I, J)`，访问对应逻辑域索引 `(i = I-g, j = J-g)`。

以上约定用于指导实现与文档撰写。任何偏离必须在模块契约中说明并给出理由。
